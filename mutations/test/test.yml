# yaml-embedded-languages: sql
---
name: pgcrypto

sql:
  - create extension pgcrypto;

---
name: auth

roles:
  - "@admin"
  - "@active"

sql:
  - create schema auth;

meta:
  # @admins are always active
  - |
    grant "@active" to "@admin";

  # No one should be able to execute anything on this schema without explicit grants.
  - up: |
     ALTER DEFAULT PRIVILEGES IN SCHEMA auth
     REVOKE EXECUTE ON FUNCTIONS FROM PUBLIC;

---
# The auth.passwords table is a way to store
name: auth.passwords
needs: [pgcrypto]
sql:
  - |
    create table auth.passwords (
      username text not null primary key,
      password text not null
    );

meta:
  - |
    create function auth.trigger_passwords_crypt() returns trigger as $$
    begin
      return new;
    end $$ language plpgsql security definer;

  - |
    create trigger on

  # login with a traditional password
  - |
    create function auth.login(username text, password text) returns ?? as $$
    begin

    end $$ language plpgsql security definer;

  # password_update gives a way to the current user to change their password
  - |
    create function auth.password_update(
      username text,
      current_password text,
      new_password text
    ) returns boolean as $$ begin

    end $$ language plpgsql;

---
# Our main schema
name: api
sql:
  - |
    create schema api;

meta:
  # No one should be able to execute anything on this schema without explicit grants.
  - up: |
     ALTER DEFAULT PRIVILEGES IN SCHEMA auth
     REVOKE EXECUTE ON FUNCTIONS FROM PUBLIC;
  - |
    grant usage on schema api to "@active";

---
name: api.users

sql:
  - |
    CREATE TABLE api.users (
      id uuid PRIMARY KEY,
      roles TEXT[],
      first_name TEXT,
      last_name TEXT,
      name text NOT NULL,
      email text NOT NULL,
      password text NOT NULL,
      created_at timestamp with time zone default now(),
      updated_at timestamp with time zone default now()
    );

meta:
  - |
    alter table api.users
      alter column id set default gen_random_uuid()
      , alter column roles set not null
      , alter column roles set default '{}'::text[]
    ;
  - |
    grant all on table api.users to "@admin";
  - |
    grant select on table api.users to "@active";
  - |
    alter table api.users enable row level security;
  - |
    create policy api.users_only_see_my_rows on api.users to "@active"
      using (pg_has_role(username, 'member'))
      with check (username = current_user or pg_has_role(current_user, '@admin', 'member'))
    ;
